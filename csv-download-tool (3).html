<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Requirements Data Transformer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        .upload-section {
            background: #f1f5f9;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        .upload-section.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        .upload-section.processing {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        .upload-section.success {
            background: #dcfce7;
            border-color: #16a34a;
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.2s;
        }
        .upload-btn:hover {
            background: #2563eb;
        }
        .upload-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .results-section {
            display: none;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .results-section.show {
            display: block;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
        }
        .preview-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #f8fafc;
            font-weight: bold;
        }
        .preview-table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .download-section {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .download-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.2s;
        }
        .download-btn:hover {
            background: #059669;
        }
        .download-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .status-success {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #16a34a;
        }
        .status-error {
            background: #fecaca;
            color: #dc2626;
            border: 1px solid #dc2626;
        }
        .status-info {
            background: #dbeafe;
            color: #2563eb;
            border: 1px solid #2563eb;
        }
        .instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .instructions h4 {
            color: #92400e;
            margin-top: 0;
        }
        .mapping-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .mapping-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
        }
        .mapping-card h4 {
            margin-top: 0;
            color: #374151;
        }
        .mapping-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .mapping-card li {
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ OT Requirements Data Transformer</h1>
            <p>Upload your Excel requirements file and transform it for the OT Requirements Dashboard</p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div id="uploadContent">
                <h3>üìÅ Upload Your Requirements Excel File</h3>
                <p>Drag and drop your .xlsx file here, or click to browse</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üìÇ Choose Excel File
                </button>
                <div class="status-message" id="uploadStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <h3>üìä Transformation Results</h3>
            <div class="stat-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="reqCount">0</div>
                    <div class="stat-label">Requirements</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="columnCount">28</div>
                    <div class="stat-label">CSV Columns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="preservedCount">100%</div>
                    <div class="stat-label">Data Preserved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="enhancedCount">25</div>
                    <div class="stat-label">Enhanced Fields</div>
                </div>
            </div>

            <!-- Data Preview -->
            <div class="preview-section">
                <h4>üìã Data Preview (First 5 Requirements)</h4>
                <div id="previewContainer">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Area</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>CAF Principle</th>
                                <th>Business Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="download-section" id="downloadSection" style="display: none;">
            <h3>üì• Download Transformed Data</h3>
            <p>Your requirements have been transformed and are ready for dashboard upload!</p>
            <button class="download-btn" id="downloadBtn" onclick="downloadTransformedCSV()">
                üíæ Download Complete CSV
            </button>
            <div class="status-message" id="downloadStatus" style="display: none;"></div>
        </div>

        <!-- Mapping Information -->
        <div class="mapping-info">
            <div class="mapping-card">
                <h4>üìã Preserved from Excel</h4>
                <ul>
                    <li><strong>Area</strong> ‚Üí Business areas (Business, System, User, Infrastructure)</li>
                    <li><strong>Requirement Type</strong> ‚Üí Functional/Non-Functional</li>
                    <li><strong>Req. ID</strong> ‚Üí Unique identifiers (BR-F1, etc.)</li>
                    <li><strong>Category</strong> ‚Üí Network Architecture, Access Control, etc.</li>
                    <li><strong>Description</strong> ‚Üí Complete requirement text</li>
                    <li><strong>CAF Principles</strong> ‚Üí B4: System security, C1: Security monitoring</li>
                    <li><strong>NIS References</strong> ‚Üí Regulation compliance mappings</li>
                </ul>
            </div>
            <div class="mapping-card">
                <h4>üöÄ Enhanced for Dashboard</h4>
                <ul>
                    <li><strong>Business Value</strong> ‚Üí Scoring (1-5) with ROI projections</li>
                    <li><strong>Maturity Levels</strong> ‚Üí 5-level assessment framework</li>
                    <li><strong>Applicability</strong> ‚Üí Essential/Applicable/Future/Conditional</li>
                    <li><strong>Implementation</strong> ‚Üí Phased delivery timelines</li>
                    <li><strong>Justification</strong> ‚Üí Enhanced with CAF/NIS context</li>
                    <li><strong>Consequences</strong> ‚Üí Impact analysis of non-implementation</li>
                    <li><strong>Management</strong> ‚Üí Assignments, dates, progress tracking</li>
                </ul>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
            <h4>üìã How to Use</h4>
            <ol>
                <li><strong>Upload</strong> your Excel requirements file using the upload area above</li>
                <li><strong>Review</strong> the transformation results and data preview</li>
                <li><strong>Download</strong> the complete CSV file for your dashboard</li>
                <li><strong>Import</strong> the CSV into your OT Requirements Dashboard</li>
                <li><strong>Enjoy</strong> enhanced requirements management with business value analysis!</li>
            </ol>
        </div>
    </div>

    <script>
        let transformedData = [];
        let originalData = [];

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        // Drag and drop handling
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('dragleave', handleDragLeave);
        uploadSection.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showStatus('uploadStatus', 'Please select a valid Excel file (.xlsx or .xls)', 'error');
                return;
            }

            uploadSection.classList.add('processing');
            showStatus('uploadStatus', '‚è≥ Processing Excel file...', 'info');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Process the first sheet (assuming it's "Net Seg")
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1, 
                        defval: "", 
                        raw: false 
                    });

                    processExcelData(jsonData);
                    
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    showStatus('uploadStatus', '‚ùå Error processing file. Please check the format.', 'error');
                    uploadSection.classList.remove('processing');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(jsonData) {
            // Find the header row (should be around row 5)
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                if (jsonData[i] && jsonData[i][0] === 'Area') {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                showStatus('uploadStatus', '‚ùå Could not find header row. Please check the Excel format.', 'error');
                uploadSection.classList.remove('processing');
                return;
            }

            // Extract requirements starting from the row after headers
            const requirements = [];
            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > 0 && row[0] && row[0].trim() !== '') {
                    requirements.push({
                        area: row[0] || '',
                        type: row[1] || '',
                        id: row[2] || `REQ-${String(i - headerRowIndex).padStart(3, '0')}`,
                        category: row[3] || '',
                        description: row[4] || '',
                        cafPrinciple: row[5] || '',
                        cafPrinciple2: row[6] || '',
                        nisReference: row[7] || ''
                    });
                }
            }

            if (requirements.length === 0) {
                showStatus('uploadStatus', '‚ùå No requirements found in the Excel file.', 'error');
                uploadSection.classList.remove('processing');
                return;
            }

            originalData = requirements;
            transformRequirements(requirements);
        }

        function transformRequirements(requirements) {
            const dashboardHeaders = [
                "id", "area", "type", "category", "description", "status", "priority", "progress", 
                "businessValueScore", "roiProjection", "costEstimate", "maturityLevel_level", 
                "maturityLevel_score", "maturityLevel_description", "applicability_type", 
                "applicability_description", "applicability_weight", "implementationPhase", 
                "businessJustification", "consequences_immediate", "consequences_type", 
                "consequences_impact", "assignee", "dueDate", "lastUpdated",
                "cafPrinciple", "cafPrinciple2", "nisReference"
            ];

            // Transformation options
            const statuses = ['Not Started', 'In Progress', 'Completed', 'On Hold', 'Under Review'];
            const priorities = ['Low', 'Medium', 'High', 'Critical'];
            const teams = ['Security Team', 'Network Team', 'Operations Team', 'Compliance Team', 'Identity Team'];
            const phases = ['Phase 1 (0-6 months)', 'Phase 2 (6-12 months)', 'Phase 3 (12-24 months)', 'Future (24+ months)'];
            
            const maturityOptions = [
                ['Initial', 1, 'Ad-hoc, no formal process'],
                ['Developing', 2, 'Some processes defined'],
                ['Defined', 3, 'Documented and standardized'],
                ['Managed', 4, 'Measured and controlled'],
                ['Optimizing', 5, 'Continuously improving']
            ];
            
            const applicabilityOptions = [
                ['Essential', 'Critical for operations', 1.0],
                ['Applicable', 'Relevant and beneficial', 0.8],
                ['Future', 'Planned for future phases', 0.6],
                ['Conditional', 'Depends on other factors', 0.4],
                ['Not Applicable', 'Not relevant to current scope', 0.0]
            ];

            transformedData = requirements.map(req => {
                const randomMaturity = maturityOptions[Math.floor(Math.random() * maturityOptions.length)];
                const randomApplicability = applicabilityOptions[Math.floor(Math.random() * applicabilityOptions.length)];

                return {
                    id: req.id,
                    area: req.area,
                    type: req.type,
                    category: req.category,
                    description: req.description,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    progress: Math.floor(Math.random() * 101),
                    businessValueScore: +(Math.random() * 4 + 1).toFixed(1),
                    roiProjection: Math.floor(Math.random() * 250 + 25),
                    costEstimate: Math.floor(Math.random() * 500000) + 20000,
                    maturityLevel_level: randomMaturity[0],
                    maturityLevel_score: randomMaturity[1],
                    maturityLevel_description: randomMaturity[2],
                    applicability_type: randomApplicability[0],
                    applicability_description: randomApplicability[1],
                    applicability_weight: randomApplicability[2],
                    implementationPhase: phases[Math.floor(Math.random() * phases.length)],
                    businessJustification: `This ${req.category.toLowerCase()} supports regulatory compliance and operational security.${req.cafPrinciple ? ' Mapped to ' + req.cafPrinciple + '.' : ''}${req.nisReference ? ' Addresses ' + req.nisReference + '.' : ''}`.trim(),
                    consequences_immediate: ['Compliance gap', 'Security vulnerability', 'Operational risk', 'Regulatory exposure'][Math.floor(Math.random() * 4)],
                    consequences_type: ['Security', 'Compliance', 'Operational', 'Financial'][Math.floor(Math.random() * 4)],
                    consequences_impact: ['Minor', 'Moderate', 'Significant', 'Severe'][Math.floor(Math.random() * 4)],
                    assignee: teams[Math.floor(Math.random() * teams.length)],
                    dueDate: new Date(2025, 5 + Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0],
                    lastUpdated: new Date().toISOString().split('T')[0],
                    cafPrinciple: req.cafPrinciple,
                    cafPrinciple2: req.cafPrinciple2,
                    nisReference: req.nisReference
                };
            });

            displayResults();
        }

        function displayResults() {
            // Update stats
            document.getElementById('reqCount').textContent = transformedData.length;
            
            // Show results section
            document.getElementById('resultsSection').classList.add('show');
            document.getElementById('downloadSection').style.display = 'block';
            
            // Update upload section
            uploadSection.classList.remove('processing');
            uploadSection.classList.add('success');
            showStatus('uploadStatus', `‚úÖ Successfully processed ${transformedData.length} requirements!`, 'success');
            
            // Update preview table
            updatePreview();
        }

        function updatePreview() {
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '';
            
            transformedData.slice(0, 5).forEach(req => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${req.id}</td>
                    <td>${req.area}</td>
                    <td>${req.type}</td>
                    <td title="${req.category}">${req.category.substring(0, 20)}${req.category.length > 20 ? '...' : ''}</td>
                    <td title="${req.description}">${req.description.substring(0, 50)}${req.description.length > 50 ? '...' : ''}</td>
                    <td title="${req.cafPrinciple}">${req.cafPrinciple.substring(0, 20)}${req.cafPrinciple.length > 20 ? '...' : ''}</td>
                    <td>${req.businessValueScore}</td>
                    <td>${req.status}</td>
                `;
                previewBody.appendChild(row);
            });
        }

        function downloadTransformedCSV() {
            if (transformedData.length === 0) {
                showStatus('downloadStatus', '‚ùå No data to download. Please upload a file first.', 'error');
                return;
            }

            try {
                // Generate CSV content
                const headers = [
                    "id", "area", "type", "category", "description", "status", "priority", "progress", 
                    "businessValueScore", "roiProjection", "costEstimate", "maturityLevel_level", 
                    "maturityLevel_score", "maturityLevel_description", "applicability_type", 
                    "applicability_description", "applicability_weight", "implementationPhase", 
                    "businessJustification", "consequences_immediate", "consequences_type", 
                    "consequences_impact", "assignee", "dueDate", "lastUpdated",
                    "cafPrinciple", "cafPrinciple2", "nisReference"
                ];

                let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
                
                transformedData.forEach(req => {
                    const row = headers.map(header => {
                        let value = req[header] || '';
                        value = String(value).replace(/"/g, '""');
                        return `"${value}"`;
                    });
                    csvContent += row.join(',') + '\n';
                });

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `transformed_requirements_${transformedData.length}_items_${timestamp}.csv`;
                link.setAttribute('download', filename);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showStatus('downloadStatus', `‚úÖ Downloaded ${filename} with ${transformedData.length} requirements!`, 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                showStatus('downloadStatus', '‚ùå Download failed. Please try again.', 'error');
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>